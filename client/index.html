<!DOCTYPE HTML>
<html>
   <head>
	   <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
      <script type="text/javascript">

        var spanInfoArr = []; // populated with objects in `tokenize` function below
                              // has positional info on all spans; hence no need to recompute
        // array of arrays with last 10 x,y positions of gaze tracker
        var coords_q = [[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1]];

        // from https://stackoverflow.com/questions/25529936/how-to-highlight-a-word-given-coordinates
        $.fn.extend({
          // this function recursively tokenizes all text nodes in an element
          tokenize: function (currId) {
            return this.not(".tokenized").each(function () {
              $(this).addClass("tokenized").children().tokenize(currId);
              $(this).contents().each(function () {
                var node = this,
                  parent = this.parentNode,
                  tokens, tokenCount;

                // text node: tokenize, dissolve into elements, remove original text node
                if (node.nodeType === 3) {
                  tokens = $(node).text().replace(/\s+/g, " ").split(" ");
                  tokenCount = tokens.length;
                  $.each(tokens, function (i, token) {
                    if (token > "") {
                      currId += 1         // each span token will have unique id
                      var tokId = "tok_" + currId.toString();
                      var wrapIn = "<span class='token' id='" + tokId + "'>";
                      parent.insertBefore($(wrapIn).text(token)[0], node);

                      // create object with just created span's relevant positional info
                      // add to global array
                      var spanInfoObj = {
                        id: tokId,
                        height: $("#" + tokId).height(),
                        pos: $("#" + tokId).position(),
                        width: $("#" + tokId).width()
                      };
                      spanInfoArr.push(spanInfoObj);
                    }
                    if (i < tokenCount - 1) {
                      parent.insertBefore(document.createTextNode(" "), node);
                    }
                  });
                  parent.removeChild(node);
                }
              });
            });
          }
        });                     

          

        function WebSocketTest()
        {
          if ("WebSocket" in window)
          {
             alert("WebSocket is supported by your Browser!");
             
             // Let us open a web socket
             var ws = new WebSocket("ws://localhost:9998/Laputa");

             ws.onopen = function()
             {
                // Web Socket is connected, send data using send()
                ws.send("Message to send");
                alert("Message is sent...");

                $("p").tokenize(0);
             };

             ws.onmessage = function (evt) 
             { 
                var received_msg = evt.data;
                console.log(received_msg);          // uncomment to log all coordinates

                var tokens = received_msg.split('|');

                if (tokens[0] === 'during') {

                  // get normalized gaze position
                  var tobii_x = tokens[1];
                  var tobii_y = tokens[2];
                  var x = tobii_x + window.screenLeft + (window.outerWidth - window.innerWidth);
                  var y = tobii_y + window.screenTop + (window.outerHeight - window.innerHeight);

                  // smoothing -- compute stabilized x and y coords
                  // use coords_q as queue sliding over past 10 x,y positions
                  // mean of these is our current position1
                  var x_sum = 0.0;
                  var y_sum = 0.0;
                  var avg_denom = 0.0; // needed b/c of initial cases where coords_q not filled fully
                  coords_q.push([x,y]);
                  coords_q.shift();
                  for(var i = 0; i < coords_q.length; i++) {
                    if (coords_q[i][0] !== -1) {
                      x_sum += parseFloat(coords_q[i][0]);
                      y_sum += parseFloat(coords_q[i][1]);
                      avg_denom += 1;
                    }
                  }
                  x = x_sum / avg_denom;
                  y = y_sum / avg_denom;


                  // draw dot at current gaze position    DO NOT DELETE THIS!!!! -- uncomment whenever you need tracer
                  /*
                  var dot_color = 'green';
                  var dot_size = '5px';
                  $("body").append(
                    $('<div></div>')
                       .css('position', 'absolute')
                       .css('top', y + 'px')
                       .css('left', x + 'px')
                       .css('width', dot_size)
                       .css('height', dot_size)
                       .css('background-color', dot_color)
                  );
                  */

                  // highlight word at current gaze position
                  $(function () {
                    // iterate through array of span objects and find id of span that matches condition
                    // then change color of span with said id
                    spanInfoArr.forEach(function(spanObj) {
                       if(y >= spanObj.pos.top && y <= spanObj.pos.top + spanObj.height && x >= spanObj.pos.left && x <= spanObj.pos.left + spanObj.width){
                          $("#" + spanObj.id).css('color', 'red');
                       }                        
                    });   
                  });         
                }
             };

             ws.onclose = function()
             { 
                // websocket is closed.
                alert("Connection is closed..."); 
             };

             window.onbeforeunload = function(event) {
                socket.close();
             };
          }
          
          else
          {
             // The browser doesn't support WebSocket
             alert("WebSocket NOT supported by your Browser!");
          }
        }
      </script>
		
   </head>
   <body>
   
      <div id="sse">
         <a href="javascript:WebSocketTest()">Run WebSocket</a>
      </div>
      <div id="sampleText">
         <p>Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Vestibulum tortor quam, feugiat vitae, ultricies eget, tempor sit amet, ante. Donec eu libero sit amet quam egestas semper. Aenean ultricies mi vitae est. Mauris placerat eleifend leo. Quisque sit amet est et sapien ullamcorper pharetra. Vestibulum erat wisi, condimentum sed, commodo vitae, ornare sit amet, wisi. Aenean fermentum, elit eget tincidunt condimentum, eros ipsum rutrum orci, sagittis tempus lacus enim ac dui. Donec non enim in turpis pulvinar facilisis. Ut felis. Praesent dapibus, neque id cursus faucibus, tortor neque egestas augue, eu vulputate magna eros eu erat. Aliquam erat volutpat. Nam dui mi, tincidunt quis, accumsan porttitor, facilisis luctus, metus</p>
         <p>Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Vestibulum tortor quam, feugiat vitae, ultricies eget, tempor sit amet, ante. Donec eu libero sit amet quam egestas semper. Aenean ultricies mi vitae est. Mauris placerat eleifend leo. Quisque sit amet est et sapien ullamcorper pharetra. Vestibulum erat wisi, condimentum sed, commodo vitae, ornare sit amet, wisi. Aenean fermentum, elit eget tincidunt condimentum, eros ipsum rutrum orci, sagittis tempus lacus enim ac dui. Donec non enim in turpis pulvinar facilisis. Ut felis. Praesent dapibus, neque id cursus faucibus, tortor neque egestas augue, eu vulputate magna eros eu erat. Aliquam erat volutpat. Nam dui mi, tincidunt quis, accumsan porttitor, facilisis luctus, metus</p>
         <p>Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Vestibulum tortor quam, feugiat vitae, ultricies eget, tempor sit amet, ante. Donec eu libero sit amet quam egestas semper. Aenean ultricies mi vitae est. Mauris placerat eleifend leo. Quisque sit amet est et sapien ullamcorper pharetra. Vestibulum erat wisi, condimentum sed, commodo vitae, ornare sit amet, wisi. Aenean fermentum, elit eget tincidunt condimentum, eros ipsum rutrum orci, sagittis tempus lacus enim ac dui. Donec non enim in turpis pulvinar facilisis. Ut felis. Praesent dapibus, neque id cursus faucibus, tortor neque egestas augue, eu vulputate magna eros eu erat. Aliquam erat volutpat. Nam dui mi, tincidunt quis, accumsan porttitor, facilisis luctus, metus</p>
         <p>Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Vestibulum tortor quam, feugiat vitae, ultricies eget, tempor sit amet, ante. Donec eu libero sit amet quam egestas semper. Aenean ultricies mi vitae est. Mauris placerat eleifend leo. Quisque sit amet est et sapien ullamcorper pharetra. Vestibulum erat wisi, condimentum sed, commodo vitae, ornare sit amet, wisi. Aenean fermentum, elit eget tincidunt condimentum, eros ipsum rutrum orci, sagittis tempus lacus enim ac dui. Donec non enim in turpis pulvinar facilisis. Ut felis. Praesent dapibus, neque id cursus faucibus, tortor neque egestas augue, eu vulputate magna eros eu erat. Aliquam erat volutpat. Nam dui mi, tincidunt quis, accumsan porttitor, facilisis luctus, metus</p>
         <p>Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Vestibulum tortor quam, feugiat vitae, ultricies eget, tempor sit amet, ante. Donec eu libero sit amet quam egestas semper. Aenean ultricies mi vitae est. Mauris placerat eleifend leo. Quisque sit amet est et sapien ullamcorper pharetra. Vestibulum erat wisi, condimentum sed, commodo vitae, ornare sit amet, wisi. Aenean fermentum, elit eget tincidunt condimentum, eros ipsum rutrum orci, sagittis tempus lacus enim ac dui. Donec non enim in turpis pulvinar facilisis. Ut felis. Praesent dapibus, neque id cursus faucibus, tortor neque egestas augue, eu vulputate magna eros eu erat. Aliquam erat volutpat. Nam dui mi, tincidunt quis, accumsan porttitor, facilisis luctus, metus</p>
         <p>Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Vestibulum tortor quam, feugiat vitae, ultricies eget, tempor sit amet, ante. Donec eu libero sit amet quam egestas semper. Aenean ultricies mi vitae est. Mauris placerat eleifend leo. Quisque sit amet est et sapien ullamcorper pharetra. Vestibulum erat wisi, condimentum sed, commodo vitae, ornare sit amet, wisi. Aenean fermentum, elit eget tincidunt condimentum, eros ipsum rutrum orci, sagittis tempus lacus enim ac dui. Donec non enim in turpis pulvinar facilisis. Ut felis. Praesent dapibus, neque id cursus faucibus, tortor neque egestas augue, eu vulputate magna eros eu erat. Aliquam erat volutpat. Nam dui mi, tincidunt quis, accumsan porttitor, facilisis luctus, metus</p>
      </div>
   </body>
</html>