<!DOCTYPE HTML>
<html>
   <head>
	   <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
      <script type="text/javascript">

        var spanInfoArr = []; // populated with objects in `tokenize` function below
                              // has positional info on all spans; hence no need to recompute
        // array of arrays with last 10 x,y positions of gaze tracker
        var coords_q = [[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1]];
        var span_line_q = ["1", "1", "1", "1", "1", "1", "1", "1", "1", "1"];
        // var linesDict = {};        /* see below - line-id dictionary of arrays */
        var prevLineNum = "1";
        var prevId = "1";

        // from https://stackoverflow.com/questions/25529936/how-to-highlight-a-word-given-coordinates
        $.fn.extend({
          // this function recursively tokenizes all text nodes in an element
          tokenize: function (currId, lineNum) {
            return this.not(".tokenized").each(function () {
              $(this).addClass("tokenized").children().tokenize(currId);
              $(this).contents().each(function () {
                var node = this,
                  parent = this.parentNode,
                  tokens, tokenCount;

                // text node: tokenize, dissolve into elements, remove original text node
                if (node.nodeType === 3) {
                  tokens = $(node).text().replace(/\s+/g, " ").split(" ");
                  tokenCount = tokens.length;
                  $.each(tokens, function (i, token) {
                    if (token > "") {
                      currId += 1         // each span token will have unique id
                      var tokId = "tok_" + currId.toString();
                      var wrapIn = "<span class='token' id='" + tokId + "'>";
                      parent.insertBefore($(wrapIn).text(token)[0], node);

                      // determine what line this word is on (if first word then line === 1)
                      if (currId > 1) {
                        var currSpanX = $("#" + tokId).position().left;
                        var prevTokId = "tok_" + (currId - 1).toString();
                        var prevSpanX =  $("#" + prevTokId).position().left;
                        lineNum = (currSpanX < prevSpanX) ? (lineNum + 1) : lineNum;
                        // if (currSpanX < prevSpanX) {     /* for debugging line changing problems */
                        //   console.log("SHIFT");
                        //   console.log(currSpanX);
                        //   console.log(prevSpanX);
                        //   console.log(prevTokId);
                        // }
                      }
                      $("#" + tokId).removeClass().addClass('token line' + lineNum.toString())

                      // create object with just created span's relevant positional info
                      // add to global array
                      var spanInfoObj = {
                        id: tokId,
                        height: $("#" + tokId).height(),
                        pos: $("#" + tokId).position(),
                        width: $("#" + tokId).width(),
                        line: lineNum
                      };
                      spanInfoArr.push(spanInfoObj);

                      /* for if we want to create a dictionary keyed by line num and with vals
                        as arrays of corresponding ids */
                      // // each line gets an array of ids corresponding to words on that line
                      // if (linesDict[lineNum]) {
                      //   linesDict[lineNum].push(tokId);
                      // } else {
                      //   linesDict[lineNum] = [tokId];
                      // }
                    }
                    if (i < tokenCount - 1) {
                      parent.insertBefore(document.createTextNode(" "), node);
                    }
                  });
                  parent.removeChild(node);
                }
              });
            });
          }
        });

        /* checks the number of times `check_line` is present in global arr span_line_q */
        function getSpanLineCount(check_line) 
        {
          var count = 0;
          span_line_q.forEach(function(curr_line) {
            if (curr_line.toString() === check_line.toString()) {
              count += 1;
            }
          });
          return count;
        }

        /* checks whether "enough" of past 10 seen tokens are on same line*/
        function getStableLineNum()
        {
          var ENOUGH_COUNT = 7;
          enoughCountLineNum = "NA" // line present 3/4 times in arr ... none yet
          span_line_q.forEach(function(span_line) {
            var line_count = getSpanLineCount(span_line);
            if (line_count >= ENOUGH_COUNT) {
              enoughCountLineNum = span_line.toString();
            }
          });
          return enoughCountLineNum;       // NA if never seen
        }                    

          
        /* Main function that runs when you click on websocket button */
        function WebSocketTest()
        {
          if ("WebSocket" in window)
          {
             alert("WebSocket is supported by your Browser!");
             
             // Let us open a web socket
             var ws = new WebSocket("ws://localhost:9998/Laputa");

             ws.onopen = function()
             {
                // Web Socket is connected, send data using send()
                ws.send("Message to send");
                alert("Message is sent...");

                $("p").tokenize(0, 1);
             };

             ws.onmessage = function (evt) 
             { 
                var received_msg = evt.data;
                // console.log(received_msg);          // uncomment to log all coordinates

                var tokens = received_msg.split('|');

                if (tokens[0] === 'during') {

                  // get normalized gaze position
                  var tobii_x = tokens[1];
                  var tobii_y = tokens[2];
                  var x = tobii_x + window.screenLeft + (window.outerWidth - window.innerWidth);
                  var y = tobii_y + window.screenTop + (window.outerHeight - window.innerHeight);


                  // fixing how y always seems 10px lower than it should be ... seems to help a bit
                  y -= 40;

                  // smoothing -- compute stabilized x and y coords
                  // use coords_q as queue sliding over past 10 x,y positions
                  // mean of these is our current position1
                  var x_sum = 0.0;
                  var y_sum = 0.0;
                  var avg_denom = 0.0; // needed b/c of initial cases where coords_q not filled fully
                  coords_q.push([x,y]);
                  coords_q.shift();
                  for(var i = 0; i < coords_q.length; i++) {
                    if (coords_q[i][0] !== -1) {
                      x_sum += parseFloat(coords_q[i][0]);
                      y_sum += parseFloat(coords_q[i][1]);
                      avg_denom += 1;
                    }
                  }
                  x = x_sum / avg_denom;
                  y = y_sum / avg_denom;

                  // draw dot at current gaze position    DO NOT DELETE!!!! -- uncomment whenever you need tracer
                  /*
                  var dot_color = 'green';
                  var dot_size = '5px';
                  $("body").append(
                    $('<div></div>')
                       .css('position', 'absolute')
                       .css('top', y + 'px')
                       .css('left', x + 'px')
                       .css('width', dot_size)
                       .css('height', dot_size)
                       .css('background-color', dot_color)
                  );
                  */

                  // highlight word at current gaze position
                  $(function () {
                    // iterate through array of span objects and find id of span that matches condition
                    // then change color of span with said id
                    spanInfoArr.forEach(function(spanObj) {
                       if(y >= spanObj.pos.top && y <= spanObj.pos.top + spanObj.height && x >= spanObj.pos.left && x <= spanObj.pos.left + spanObj.width){


                        /* using best 7 of 10 method
                          ensures that eyes wandering to random words doesnt cause immediate change of 
                          line, you want a flow, i.e. mimicking how people actually read
                        */
                        if (spanObj.id.toString() !== prevId) {
                          prevId = spanObj.id.toString();
                          span_line_q.push(spanObj.line.toString());
                          span_line_q.shift();
                          var currLineNum = getStableLineNum();
                          if (currLineNum !== "NA") {   // if it is NA then youre moving fast hence stick with previous
                            // $(".line" + prevLineNum.toString()).css('color', 'black'); // if you wanna do smthng with prev
                            $(".token").css('color','grey');                             // make everything else grey
                            $(".line" + currLineNum.toString()).css('color', 'blue');    // current line blue
                            prevLineNum = currLineNum;
                          }                            
                        }


                        /* the raw method, follows your eyes everywhere - can do by word or line */
                        // $(".line" + spanObj.line.toString()).css('color', 'green');
                        //$("#" + spanObj.id).css('color', 'red');
                       }                        
                    });   
                  });         
                }
             };

             ws.onclose = function()
             { 
                // websocket is closed.
                alert("Connection is closed..."); 
             };

             window.onbeforeunload = function(event) {
                socket.close();
             };
          }
          
          else
          {
             // The browser doesn't support WebSocket
             alert("WebSocket NOT supported by your Browser!");
          }
        }
      </script>


      <style>
        p 
        {
          font-size: 16px;
        }
      </style>
		
   </head>
   <body>
   
      <div id="sse">
         <a href="javascript:WebSocketTest()">Run WebSocket</a>
      </div>
      <div id="sampleText">
         <p>Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Vestibulum tortor quam, feugiat vitae, ultricies eget, tempor sit amet, ante. Donec eu libero sit amet quam egestas semper. Aenean ultricies mi vitae est. Mauris placerat eleifend leo. Quisque sit amet est et sapien ullamcorper pharetra. Vestibulum erat wisi, condimentum sed, commodo vitae, ornare sit amet, wisi. Aenean fermentum, elit eget tincidunt condimentum, eros ipsum rutrum orci, sagittis tempus lacus enim ac dui. Donec non enim in turpis pulvinar facilisis. Ut felis. Praesent dapibus, neque id cursus faucibus, tortor neque egestas augue, eu vulputate magna eros eu erat. Aliquam erat volutpat. Nam dui mi, tincidunt quis, accumsan porttitor, facilisis luctus, metus</p>
         <p>Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Vestibulum tortor quam, feugiat vitae, ultricies eget, tempor sit amet, ante. Donec eu libero sit amet quam egestas semper. Aenean ultricies mi vitae est. Mauris placerat eleifend leo. Quisque sit amet est et sapien ullamcorper pharetra. Vestibulum erat wisi, condimentum sed, commodo vitae, ornare sit amet, wisi. Aenean fermentum, elit eget tincidunt condimentum, eros ipsum rutrum orci, sagittis tempus lacus enim ac dui. Donec non enim in turpis pulvinar facilisis. Ut felis. Praesent dapibus, neque id cursus faucibus, tortor neque egestas augue, eu vulputate magna eros eu erat. Aliquam erat volutpat. Nam dui mi, tincidunt quis, accumsan porttitor, facilisis luctus, metus</p>
         <p>Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Vestibulum tortor quam, feugiat vitae, ultricies eget, tempor sit amet, ante. Donec eu libero sit amet quam egestas semper. Aenean ultricies mi vitae est. Mauris placerat eleifend leo. Quisque sit amet est et sapien ullamcorper pharetra. Vestibulum erat wisi, condimentum sed, commodo vitae, ornare sit amet, wisi. Aenean fermentum, elit eget tincidunt condimentum, eros ipsum rutrum orci, sagittis tempus lacus enim ac dui. Donec non enim in turpis pulvinar facilisis. Ut felis. Praesent dapibus, neque id cursus faucibus, tortor neque egestas augue, eu vulputate magna eros eu erat. Aliquam erat volutpat. Nam dui mi, tincidunt quis, accumsan porttitor, facilisis luctus, metus</p>
         <p>Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Vestibulum tortor quam, feugiat vitae, ultricies eget, tempor sit amet, ante. Donec eu libero sit amet quam egestas semper. Aenean ultricies mi vitae est. Mauris placerat eleifend leo. Quisque sit amet est et sapien ullamcorper pharetra. Vestibulum erat wisi, condimentum sed, commodo vitae, ornare sit amet, wisi. Aenean fermentum, elit eget tincidunt condimentum, eros ipsum rutrum orci, sagittis tempus lacus enim ac dui. Donec non enim in turpis pulvinar facilisis. Ut felis. Praesent dapibus, neque id cursus faucibus, tortor neque egestas augue, eu vulputate magna eros eu erat. Aliquam erat volutpat. Nam dui mi, tincidunt quis, accumsan porttitor, facilisis luctus, metus</p>
         <p>Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Vestibulum tortor quam, feugiat vitae, ultricies eget, tempor sit amet, ante. Donec eu libero sit amet quam egestas semper. Aenean ultricies mi vitae est. Mauris placerat eleifend leo. Quisque sit amet est et sapien ullamcorper pharetra. Vestibulum erat wisi, condimentum sed, commodo vitae, ornare sit amet, wisi. Aenean fermentum, elit eget tincidunt condimentum, eros ipsum rutrum orci, sagittis tempus lacus enim ac dui. Donec non enim in turpis pulvinar facilisis. Ut felis. Praesent dapibus, neque id cursus faucibus, tortor neque egestas augue, eu vulputate magna eros eu erat. Aliquam erat volutpat. Nam dui mi, tincidunt quis, accumsan porttitor, facilisis luctus, metus</p>
         <p>Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Vestibulum tortor quam, feugiat vitae, ultricies eget, tempor sit amet, ante. Donec eu libero sit amet quam egestas semper. Aenean ultricies mi vitae est. Mauris placerat eleifend leo. Quisque sit amet est et sapien ullamcorper pharetra. Vestibulum erat wisi, condimentum sed, commodo vitae, ornare sit amet, wisi. Aenean fermentum, elit eget tincidunt condimentum, eros ipsum rutrum orci, sagittis tempus lacus enim ac dui. Donec non enim in turpis pulvinar facilisis. Ut felis. Praesent dapibus, neque id cursus faucibus, tortor neque egestas augue, eu vulputate magna eros eu erat. Aliquam erat volutpat. Nam dui mi, tincidunt quis, accumsan porttitor, facilisis luctus, metus</p>
      </div>
   </body>
</html>