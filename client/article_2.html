<!DOCTYPE HTML>
<html>
   <head>
	   <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
      <script type="text/javascript">    
        // array of arrays with last 10 x,y positions of gaze tracker
        var coords_q = [[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1],[-1,-1]];

        var linesCounterDict = {};      // maps line nums to what proportion of units of time that line was seen

        // populate the dictionary - could be done much simpler with lodash        
        var tempArr = Array.apply(null, Array(51)).map(function (_, i) {return i;});
        tempArr.forEach(function(index) {
          linesCounterDict[index] = 0;
        });

        var INDEX_URL = "file:///C:/Users/Kathryn Faolin/Documents/thesis/client/index.html";


        /* Main function that runs when you click on websocket button */
        function WebSocketTest()
        {
          if ("WebSocket" in window)

          {
            //alert("WebSocket is supported by your Browser!");
             
            // Let us open a web socket
            var ws = new WebSocket("ws://localhost:9998/Laputa");

            var buttonStop = document.getElementById("stop-button");
            buttonStop.onclick = function() {
              // Close the connection, if open.
              if (ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({khloe: linesCounterDict}));
                ws.close();
                window.location.href = INDEX_URL; // causes log to dissapear
              }
            }

            ws.onopen = function()
            {
              // Web Socket is connected, send data using send()
              ws.send("Socket Opened");
              //alert("Message is sent...");

            };

            ws.onmessage = function (evt) 
            { 
              var received_msg = evt.data;
              // console.log(received_msg);          // uncomment to log all coordinates

              var tokens = received_msg.split('|');

              if (tokens[0] === 'during') {

                // get normalized gaze position
                var tobii_x = tokens[1];
                var tobii_y = tokens[2];
                var x = tobii_x + window.screenLeft + (window.outerWidth - window.innerWidth);
                var y = tobii_y + window.screenTop - (window.outerHeight - window.innerHeight);

                // smoothing -- compute stabilized x and y coords
                // use coords_q as queue sliding over past 10 x,y positions
                // mean of these is our current position1
                var x_sum = 0.0;
                var y_sum = 0.0;
                var avg_denom = 0.0; // needed b/c of initial cases where coords_q not filled fully
                coords_q.push([x,y]);
                coords_q.shift();
                for(var i = 0; i < coords_q.length; i++) {
                  if (coords_q[i][0] !== -1) {
                    x_sum += parseFloat(coords_q[i][0]);
                    y_sum += parseFloat(coords_q[i][1]);
                    avg_denom += 1;
                  }
                }
                x = x_sum / avg_denom;
                y = y_sum / avg_denom;

                // add an offset to deal with slight innacuracy (one line' worth)
                y += 28;

                // draw dot at current gaze position    DO NOT DELETE!!!! -- uncomment whenever you need tracer
                /*
                var dot_color = 'green';
                var dot_size = '5px';
                $("body").append(
                  $('<div></div>')
                     .css('position', 'absolute')
                     .css('top', y + 'px')
                     .css('left', x + 'px')
                     .css('width', dot_size)
                     .css('height', dot_size)
                     .css('background-color', dot_color)
                );
                */
                

                // highlight word at current gaze position
                $(function () {


                  /////////////////////////////////////////////////////////////////////////////////
                  // HIGHLIGHTING MECHANISM
                  // inspired by: https://stackoverflow.com/questions/2456442/how-can-i-highlight-the-line-of-text-that-is-closest-to-the-mouse/2456631#2456631
                  // and hence: http://jsbin.com/avuku/15/edit?html,js,output
                  /////////////////////////////////////////////////////////////////////////////////

                  var lines = document.getElementById("wrappingText").getClientRects();  // declared globally instead
                  var highlighter = document.getElementById("highlighter");

                  // all the action
                  for (var i=0, max = lines.length; i < max; i++)
                  {
                      if (y > lines[i].top && y < lines[i].bottom)
                      {
                        linesCounterDict[i] += 1; // update global line counter

                        var centerPos = lines[i].top;
                        var bottomPos = lines[i].bottom;
                        if (lines[i+1] !== null && lines[i+1] !== undefined) {
                          bottomPos = lines[i+1].top;  
                        }                                                        
                        var hlightHeight = bottomPos - centerPos;
                        var topPos = centerPos - hlightHeight;
                        if (lines[i-1] !== null && lines[i-1] !== undefined) {
                          topPos = lines[i-1].top;  
                        } 
                        /* // other way for top and bottom pos
                        var topPos = centerPos - hlightHeight;
                        var bottomPos = centerPos + hlightHeight;
                        */

                        // height of each highlighter is same
                        $(".hlighterCenter, .hlighterOuter").css("height", hlightHeight);

                        // positions of top bottom and center
                        $("#hlighterTop").css("top", topPos);                                                   
                        $(".hlighterCenter").css("top", centerPos);
                        $("#hlighterBottom").css("top", bottomPos);                           
                        break;
                      } 
                  }

                });       
              }
            };

            ws.onclose = function()
            { 
              // websocket is closed.
              // alert("Connection is closed..."); 
            };

            window.onbeforeunload = function(event) {
              socket.close();
            };
          }
          
          else
          {
             // The browser doesn't support WebSocket
             alert("WebSocket NOT supported by your Browser!");
          }
        }
      </script>


      <style type="text/css">
        div 
        {
          font-size: 16px;
          font-family: 'Georgia';
          line-height: 28px;
        }
        .hlighter {
          position:absolute;
          width:100%;
          z-index: -1;
        }
        /* for box shadow: https://stackoverflow.com/questions/45143916/dim-entire-screen-except-a-fixed-area */
        /* this box shadow is doing something to the opacity of the top highlighter div, but no issue yet */
        .hlighterCenter {
          background-color:white;
          box-shadow: 0 0 0 100vmax rgba(0,0,0,.18);
        }
        .hlighterOuter {
          background-color:khaki;
          opacity: 0.5;    
        }
        #wrappingText {
          display: inline;
        } 
        #container {
        }
      </style>
		
   </head>
   <body>
   
      <div id="sse">
         <button onclick="WebSocketTest()">RUN</button>
         <button id="stop-button">BACK</button>
      </div>
    
      <div id="container">
        <div class="hlighter hlighterOuter" id="hlighterTop"></div>
        <div class="hlighter hlighterCenter"></div>
        <div class="hlighter hlighterOuter" id="hlighterBottom"></div>
        <div id="wrappingText">
        Ellen DeGeneres continued her lucky streak of getting Kardashian-Jenners to speak on record about the Khloé Kardashian-Tristan Thompson cheating scandal on her show today with Kris Jenner's appearance. Khloé's mom got emotional talking about her daughter giving birth after videos surfaced of Khloé's boyfriend allegedly cheating on her during her pregnancy. "Khloé is amazing," Kris started. "I’m so proud of that kid, yeah. I get choked up because she’s such a good mom, and honestly, I get so emotional. I was in Cleveland last week, and it was snowing, and she was all nestled in in the nursery and the baby and she’s just concentrating on that: just being a mom, her baby, and I think that’s what her sisters are doing as well so we’re all so—she’s so excited about motherhood and trying to get the nursing thing down, which is a little tricky."
        </br>
        Kris called the Thompson situation "very unexpected," but spent more time praising Khloé's parenting and response to it. "She’s figuring it out one day at a time and she’s just the best mom already, and that baby is so cute, little True," Kris said.Ellen pressed and tried to get Kris to talk more about her personal feelings about the Tristan matter. "But as a mom, let’s just take the whole, your television show aside, everything aside, it’s your daughter and she’s about to have a baby," Ellen said. "Literally, any day, and then that video comes out of him. I mean, you must—and also including the show like, what are you doing to my daughter, number one, you must have been furious..."
        </br>
        Kris didn't bite. "I think we do what we always do. and that’s spring into action with love," she responded. "And we all hopped on a plane and flew to Cleveland ‘cause that’s what we know to do. I’m there to support my kids no matter what happens. And I just do the best I can. Just like anybody else would for their family, you know so we all kind of do it. There’s a lot of us, you know? We all get together, and we do things together and we’re a force to be reckoned with so we get there, and we’re like supporting her. She gave birth probably within hours after us arriving. It was crazy. It was very exciting at the same time." The scandal and birth "was all simultaneously happening," Kris clarified. "I mean, we knew she was gonna have the baby within a week, and then I brought the doctor. So I had the doctor on the line and the nurse practitioner and I was like, we’ve got to get there! And then we were calling from the plane being like, ‘What’s going on?’ ‘She just got her epidural.’ And we’re like, ‘What?!’ And so I didn’t even think we would make it so [but] we did."
        </br>
        Ellen got Kris to also confirm she definitely lied about Kylie Jenner's pregnancy and periodically fibs to keep the family's secrets. She also asked Kris directly what's going on with Kanye and whether he's okay. Kris responded diplomatically: "You know, Kanye has a lot of love for all of you, all of his fans. And everybody who’s been there to support him forever, and I know that he will explain himself in his own way. And I think that anything he does—and I just think this is important to say—is he always does things with really good intentions. So I’m going to let him explain himself when the time’s ready, and I just keep rolling on, trying to keep up."
        </div>
      </div>
  
   </body>
</html>